name: Publish Release Candidate

on:
  pull_request:
    types: [ labeled ]

jobs:
  check-publish-label:
    name: Check Publish Label
    runs-on: ubuntu-latest
    if: github.event.label.name == 'publish'
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Check label
        id: check
        run: echo "should_publish=true" >> $GITHUB_OUTPUT

  check-version-conflict:
    name: Check Version Conflict
    runs-on: ubuntu-latest
    needs: [check-publish-label]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Conan
        run: pip install conan==2.0.17
      
      - name: Configure Conan
        run: |
          conan profile detect --force
          conan remote add conan-stable ${{ secrets.CONAN_STABLE_REMOTE }} || true
          conan remote login conan-stable ${{ secrets.CONAN_LOGIN_USERNAME }} -p ${{ secrets.CONAN_PASSWORD }}
      
      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version = ' conanfile.py | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Check if version exists in stable
        id: check_version
        run: |
          if conan list "mylib/${{ steps.version.outputs.version }}@*" --remote=conan-stable 2>/dev/null | grep -q "mylib/${{ steps.version.outputs.version }}"; then
            echo "::error::Version ${{ steps.version.outputs.version }} already exists in conan-stable. Please bump the version."
            exit 1
          fi
          echo "Version check passed"

  build-rc-packages:
    name: Build RC Package (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [check-version-conflict]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            profile: linux-gcc
          - os: macos-latest
            profile: macos-clang
          - os: windows-latest
            profile: windows-msvc
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup C++ Environment
        uses: dmitritelinov/shared-cicd-actions/setup-cpp-env@main
        with:
          os: ${{ matrix.os }}
      
      - name: Install Conan
        run: pip install conan==2.0.17
      
      - name: Configure Conan
        shell: bash
        run: |
          conan profile detect --force
          conan remote add conan-rc ${{ secrets.CONAN_RC_REMOTE }} || true
          conan remote login conan-rc ${{ secrets.CONAN_LOGIN_USERNAME }} -p ${{ secrets.CONAN_PASSWORD }}
      
      - name: Get version info
        id: version
        shell: bash
        run: |
          VERSION=$(grep 'version = ' conanfile.py | cut -d'"' -f2)
          SHORT_SHA=$(git rev-parse --short HEAD)
          RC_VERSION="$VERSION-dev-$SHORT_SHA"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "rc_version=$RC_VERSION" >> $GITHUB_OUTPUT
      
      - name: Build RC Package
        uses: dmitritelinov/shared-cicd-actions/conan-build@main
        with:
          version: ${{ steps.version.outputs.rc_version }}
          profile: profiles/${{ matrix.profile }}
      
      - name: Upload RC Package
        uses: dmitritelinov/shared-cicd-actions/conan-publish@main
        with:
          package: "mylib/${{ steps.version.outputs.rc_version }}"
          remote: conan-rc
          username: ${{ secrets.CONAN_LOGIN_USERNAME }}
          password: ${{ secrets.CONAN_PASSWORD }}
      
      - name: Save package reference
        shell: bash
        run: |
          echo "mylib/${{ steps.version.outputs.rc_version }}" > package-ref-${{ matrix.os }}.txt
      
      - name: Upload package reference
        uses: actions/upload-artifact@v4
        with:
          name: package-ref-${{ matrix.os }}
          path: package-ref-${{ matrix.os }}.txt

  create-status-check:
    name: RC Packages Ready
    runs-on: ubuntu-latest
    needs: [build-rc-packages]
    steps:
      - name: Download all package references
        uses: actions/download-artifact@v4
      
      - name: Display package references
        run: |
          echo "Release Candidate packages built successfully:"
          cat package-ref-*/package-ref-*.txt
      
      - name: Create comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const packages = fs.readdirSync('.')
              .filter(f => f.startsWith('package-ref-'))
              .map(f => fs.readFileSync(f + '/' + fs.readdirSync(f)[0], 'utf8').trim())
              .join('\n- ');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Release Candidate Packages Built
              
The following RC packages have been published to conan-rc and are ready for release:

- ${packages}

The PR can now be merged to publish these packages to conan-stable.`
            });