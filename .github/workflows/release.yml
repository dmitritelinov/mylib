name: Release

on:
  pull_request:
    types: [ closed ]
    branches: [ main ]

jobs:
  check-merge-and-label:
    name: Check Merge and Label
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      has_publish_label: ${{ steps.check.outputs.has_publish_label }}
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      rc_version: ${{ steps.version.outputs.rc_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for publish label
        id: check
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | jq -e 'any(. == "publish")' > /dev/null; then
            echo "has_publish_label=true" >> $GITHUB_OUTPUT
          else
            echo "has_publish_label=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'version = ' conanfile.py | cut -d'"' -f2)
          SHORT_SHA=$(git rev-parse --short ${{ github.event.pull_request.merge_commit_sha }})
          RC_VERSION="$VERSION-dev-$SHORT_SHA"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "rc_version=$RC_VERSION" >> $GITHUB_OUTPUT

  promote-to-stable:
    name: Promote to Stable (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [check-merge-and-label]
    if: needs.check-merge-and-label.outputs.has_publish_label == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            profile: linux-gcc
          - os: macos-latest
            profile: macos-clang
          - os: windows-latest
            profile: windows-msvc
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup C++ Environment
        uses: dmitritelinov/shared-cicd-actions/setup-cpp-env@main
        with:
          os: ${{ matrix.os }}
      
      - name: Install Conan
        run: pip install conan==2.0.17
      
      - name: Configure Conan remotes
        shell: bash
        run: |
          conan profile detect --force
          conan remote add conan-rc ${{ secrets.CONAN_RC_REMOTE }} || true
          conan remote add conan-stable ${{ secrets.CONAN_STABLE_REMOTE }} || true
          conan remote login conan-rc ${{ secrets.CONAN_LOGIN_USERNAME }} -p ${{ secrets.CONAN_PASSWORD }}
          conan remote login conan-stable ${{ secrets.CONAN_LOGIN_USERNAME }} -p ${{ secrets.CONAN_PASSWORD }}
      
      - name: Download RC package
        shell: bash
        run: |
          conan download "mylib/${{ needs.check-merge-and-label.outputs.rc_version }}" \
            --remote=conan-rc
      
      - name: Build stable package
        shell: bash
        run: |
          conan create . --version=${{ needs.check-merge-and-label.outputs.version }} \
            --profile=profiles/${{ matrix.profile }} \
            --build=missing
      
      - name: Upload to stable
        shell: bash
        run: |
          conan upload "mylib/${{ needs.check-merge-and-label.outputs.version }}" \
            --remote=conan-stable --confirm

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-merge-and-label, promote-to-stable]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.check-merge-and-label.outputs.version }}" \
            -m "Release version ${{ needs.check-merge-and-label.outputs.version }}"
          git push origin "v${{ needs.check-merge-and-label.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: 'v${{ needs.check-merge-and-label.outputs.version }}',
              name: 'Release v${{ needs.check-merge-and-label.outputs.version }}',
              body: `## Release v${{ needs.check-merge-and-label.outputs.version }}
              
### Conan Packages

This release is available via Conan:

\`\`\`bash
conan install --requires=mylib/${{ needs.check-merge-and-label.outputs.version }}
\`\`\`

### Platforms

- Linux (GCC 11)
- macOS (Apple Clang 14)
- Windows (MSVC 193)

### Changes

${{ steps.changelog.outputs.changelog }}

### Installation

Add to your \`conanfile.txt\`:

\`\`\`
[requires]
mylib/${{ needs.check-merge-and-label.outputs.version }}
\`\`\`

Or use CMake directly:

\`\`\`cmake
find_package(mylib CONFIG REQUIRED)
target_link_libraries(your_target PRIVATE mylib::mylib)
\`\`\`
              `,
              draft: false,
              prerelease: false
            });
            
            core.setOutput('release_id', release.data.id);
            core.setOutput('upload_url', release.data.upload_url);
      
      - name: Post release notification
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Release Published
              
Version **v${{ needs.check-merge-and-label.outputs.version }}** has been released!

ðŸ“¦ [View Release](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${{ needs.check-merge-and-label.outputs.version }})

The package is now available on conan-stable.`
            });