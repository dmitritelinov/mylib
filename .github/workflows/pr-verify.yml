name: PR Verification

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, labeled, unlabeled ]

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format
      
      - name: Check formatting
        run: |
          find src include tests -name '*.cpp' -o -name '*.h' | xargs clang-format --dry-run --Werror

  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            profile: linux-gcc
          - os: macos-latest
            profile: macos-clang
          - os: windows-latest
            profile: windows-msvc
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup C++ Environment
        uses: dmitritelinov/shared-cicd-actions/setup-cpp-env@main
        with:
          os: ${{ matrix.os }}
      
      - name: Install Conan
        run: pip install conan==2.24.0
      
      - name: Configure Conan
        run: |
          conan profile detect --force
          conan remote add conan-rc ${{ secrets.CONAN_RC_REMOTE }} || true
      
      - name: Install dependencies with lockfile
        run: |
          conan lock create . --profile=profiles/${{ matrix.profile }} --lockfile-out=conan.lock
          conan install . -pr:a=profiles/${{ matrix.profile }} --build=missing --lockfile=conan.lock
      
      - name: Configure CMake Windows
        if: runner.os == 'Windows'
        run:
          cmake --preset conan-default -DBUILD_TESTING=ON

      - name: Configure CMake
        if: runner.os != 'Windows'
        run:
          cmake --preset conan-release -DBUILD_TESTING=ON
            
      - name: Build
        run:
          cmake --build --preset conan-release     
      
      - name: Run Tests
        uses: dmitritelinov/shared-cicd-actions/run-tests@main
        with:
          preset: conan-release

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'verify')
    needs: [build-and-test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Conan
        run: pip install conan==2.24.0
      
      - name: Configure Conan
        run: |
          conan profile detect --force
          conan remote add conan-rc ${{ secrets.CONAN_RC_REMOTE }} || true
          conan remote login conan-rc ${{ secrets.CONAN_LOGIN_USERNAME }} -p ${{ secrets.CONAN_PASSWORD }}
      
      - name: Build RC package
        run: |
          conan create . \
            --profile=profiles/linux-gcc \
            --build=missing
      
      - name: Upload RC package
        run: |
          conan upload "mylib/*" \
            --remote=conan-rc --confirm
      
      - name: Create consumer test project
        run: |
          export MYLIB=$(ls mylib/*)
          mkdir -p consumer_test
          cd consumer_test
          cat > conanfile.txt << EOF
          [requires]
          mylib/${{ env.MYLIB }}
          
          [generators]
          CMakeDeps
          CMakeToolchain
          EOF
          
          cat > CMakeLists.txt << EOF
          cmake_minimum_required(VERSION 3.15)
          project(ConsumerTest)
          
          find_package(mylib CONFIG REQUIRED)
          
          add_executable(test_consumer main.cpp)
          target_link_libraries(test_consumer PRIVATE mylib::mylib)
          EOF
          
          cat > main.cpp << EOF
          #include <mylib/mylib.h>
          #include <iostream>
          
          int main() {
              int result = mylib::sum(5, 3);
              std::cout << "5 + 3 = " << result << std::endl;
              return (result == 8) ? 0 : 1;
          }
          EOF
      
      - name: Build and test consumer
        run: |
          cd consumer_test
          conan install . --profile=../profiles/linux-gcc --build=missing
          cmake --preset conan-release
          cmake --build --preset conan-release
          ./build/Release/test_consumer

  verify-lockfile:
    name: Verify Dependency Lockfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Conan
        run: pip install conan==2.24.0
      
      - name: Configure Conan
        run: conan profile detect --force
      
      - name: Generate lockfile
        run: |
          conan lock create . --profile=profiles/linux-gcc --lockfile-out=conan.lock.generated
      
      - name: Check if lockfile exists and is up to date
        run: |
          if [ ! -f conan.lock ]; then
            echo "::warning::No conan.lock found. Creating one."
            mv conan.lock.generated conan.lock
            git diff --exit-code conan.lock || echo "::error::Lockfile needs to be committed"
          else
            if ! diff -q conan.lock conan.lock.generated; then
              echo "::error::Lockfile is out of date. Please regenerate with: conan lock create . --profile=profiles/linux-gcc --lockfile-out=conan.lock"
              exit 1
            fi
          fi